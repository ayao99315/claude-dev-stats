/**
 * åŒè¯­æŠ¥å‘Šæ¨¡æ¿ç³»ç»Ÿ
 * æä¾›ä¸­è‹±æ–‡åŒè¯­æŠ¥å‘Šæ¨¡æ¿ï¼Œæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼
 */

import { 
  ReportTemplate, 
  ReportConfig, 
  ReportFormat, 
  ReportType, 
  Language, 
  BilingualText,
  RenderContext,
  TableConfig,
  ChartConfig,
  MetricCard,
  InsightCard
} from '../types/reports';
import { 
  AnalysisResult, 
  BasicStats, 
  EfficiencyMetrics, 
  SmartInsights,
  TrendAnalysis,
  CostAnalysis,
  ToolUsageAnalysis
} from '../types/analytics';

/**
 * åŒè¯­æ–‡æœ¬ç®¡ç†å™¨
 * ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç•Œé¢æ–‡æœ¬çš„ä¸­è‹±æ–‡ç¿»è¯‘
 */
export class BilingualTextManager {
  private texts: Record<string, BilingualText> = {
    // æŠ¥å‘Šæ ‡é¢˜
    'report.title.daily': {
      'zh-CN': 'ğŸ“Š Claude Code æ—¥æŠ¥',
      'en-US': 'ğŸ“Š Claude Code Daily Report'
    },
    'report.title.efficiency': {
      'zh-CN': 'âš¡ æ•ˆç‡åˆ†ææŠ¥å‘Š',
      'en-US': 'âš¡ Efficiency Analysis Report'
    },
    'report.title.trends': {
      'zh-CN': 'ğŸ“ˆ è¶‹åŠ¿åˆ†ææŠ¥å‘Š',
      'en-US': 'ğŸ“ˆ Trend Analysis Report'
    },
    'report.title.insights': {
      'zh-CN': 'ğŸ” æ™ºèƒ½æ´å¯ŸæŠ¥å‘Š',
      'en-US': 'ğŸ” Smart Insights Report'
    },
    'report.title.cost': {
      'zh-CN': 'ğŸ’° æˆæœ¬åˆ†ææŠ¥å‘Š',
      'en-US': 'ğŸ’° Cost Analysis Report'
    },

    // è¡¨æ ¼æ ‡é¢˜
    'table.basic_stats': {
      'zh-CN': 'ğŸ“‹ åŸºç¡€ç»Ÿè®¡',
      'en-US': 'ğŸ“‹ Basic Statistics'
    },
    'table.efficiency': {
      'zh-CN': 'âš¡ æ•ˆç‡æŒ‡æ ‡',
      'en-US': 'âš¡ Efficiency Metrics'
    },
    'table.tool_usage': {
      'zh-CN': 'ğŸ”§ å·¥å…·ä½¿ç”¨',
      'en-US': 'ğŸ”§ Tool Usage'
    },

    // åˆ—æ ‡é¢˜
    'column.metric': {
      'zh-CN': 'æŒ‡æ ‡',
      'en-US': 'Metric'
    },
    'column.value': {
      'zh-CN': 'æ•°å€¼',
      'en-US': 'Value'
    },
    'column.tool': {
      'zh-CN': 'å·¥å…·',
      'en-US': 'Tool'
    },
    'column.usage': {
      'zh-CN': 'ä½¿ç”¨æ¬¡æ•°',
      'en-US': 'Usage Count'
    },
    'column.efficiency': {
      'zh-CN': 'æ•ˆç‡è¯„åˆ†',
      'en-US': 'Efficiency Score'
    },

    // æŒ‡æ ‡åç§°
    'metric.total_time': {
      'zh-CN': 'æ€»å·¥ä½œæ—¶é—´',
      'en-US': 'Total Time'
    },
    'metric.total_tokens': {
      'zh-CN': 'æ€»Tokenæ¶ˆè€—',
      'en-US': 'Total Tokens'
    },
    'metric.total_cost': {
      'zh-CN': 'æ€»æˆæœ¬',
      'en-US': 'Total Cost'
    },
    'metric.files_modified': {
      'zh-CN': 'ä¿®æ”¹æ–‡ä»¶æ•°',
      'en-US': 'Files Modified'
    },
    'metric.productivity_score': {
      'zh-CN': 'ç”Ÿäº§åŠ›è¯„åˆ†',
      'en-US': 'Productivity Score'
    },
    'metric.tokens_per_hour': {
      'zh-CN': 'Token/å°æ—¶',
      'en-US': 'Tokens/Hour'
    },
    'metric.lines_per_hour': {
      'zh-CN': 'ä»£ç è¡Œæ•°/å°æ—¶',
      'en-US': 'Lines/Hour'
    },

    // æ•ˆç‡è¯„çº§
    'rating.excellent': {
      'zh-CN': 'å“è¶Š',
      'en-US': 'Excellent'
    },
    'rating.good': {
      'zh-CN': 'è‰¯å¥½',
      'en-US': 'Good'
    },
    'rating.average': {
      'zh-CN': 'ä¸€èˆ¬',
      'en-US': 'Average'
    },
    'rating.poor': {
      'zh-CN': 'è¾ƒå·®',
      'en-US': 'Poor'
    },

    // è¶‹åŠ¿æè¿°
    'trend.increasing': {
      'zh-CN': 'ä¸Šå‡',
      'en-US': 'Increasing'
    },
    'trend.decreasing': {
      'zh-CN': 'ä¸‹é™',
      'en-US': 'Decreasing'
    },
    'trend.stable': {
      'zh-CN': 'ç¨³å®š',
      'en-US': 'Stable'
    },

    // æŠ¥å‘ŠèŠ‚
    'section.summary': {
      'zh-CN': 'ğŸ“Š æ¦‚è§ˆ',
      'en-US': 'ğŸ“Š Summary'
    },
    'section.detailed_stats': {
      'zh-CN': 'ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡',
      'en-US': 'ğŸ“ˆ Detailed Statistics'
    },
    'section.insights': {
      'zh-CN': 'ğŸ’¡ æ™ºèƒ½æ´å¯Ÿ',
      'en-US': 'ğŸ’¡ Smart Insights'
    },
    'section.recommendations': {
      'zh-CN': 'ğŸ¯ æ”¹è¿›å»ºè®®',
      'en-US': 'ğŸ¯ Recommendations'
    },

    // æ—¶é—´å•ä½
    'time.hours': {
      'zh-CN': 'å°æ—¶',
      'en-US': 'hours'
    },
    'time.minutes': {
      'zh-CN': 'åˆ†é’Ÿ',
      'en-US': 'minutes'
    },

    // æ•°æ®è´¨é‡
    'quality.excellent': {
      'zh-CN': 'ä¼˜ç§€',
      'en-US': 'Excellent'
    },
    'quality.good': {
      'zh-CN': 'è‰¯å¥½',
      'en-US': 'Good'
    },
    'quality.fair': {
      'zh-CN': 'ä¸€èˆ¬',
      'en-US': 'Fair'
    },
    'quality.poor': {
      'zh-CN': 'è¾ƒå·®',
      'en-US': 'Poor'
    },

    // æŠ¥å‘Šå°¾éƒ¨
    'footer.generated_by': {
      'zh-CN': 'ç”± Claude Code Stats ç”Ÿæˆ',
      'en-US': 'Generated by Claude Code Stats'
    },
    'footer.version': {
      'zh-CN': 'ç‰ˆæœ¬',
      'en-US': 'Version'
    }
  };

  /**
   * è·å–ç¿»è¯‘æ–‡æœ¬
   * @param key æ–‡æœ¬é”®å
   * @param language è¯­è¨€
   * @returns ç¿»è¯‘åçš„æ–‡æœ¬
   */
  getText(key: string, language: Language): string {
    const text = this.texts[key];
    if (!text) {
      return key; // å¦‚æœæ‰¾ä¸åˆ°ç¿»è¯‘ï¼Œè¿”å›é”®å
    }
    return text[language] || text['zh-CN'] || key;
  }

  /**
   * æ·»åŠ æ–°çš„ç¿»è¯‘æ–‡æœ¬
   * @param key æ–‡æœ¬é”®å
   * @param texts ä¸­è‹±æ–‡æ–‡æœ¬å¯¹
   */
  addText(key: string, texts: BilingualText): void {
    this.texts[key] = texts;
  }
}

/**
 * æŠ¥å‘Šæ ¼å¼åŒ–å·¥å…·
 * æä¾›å„ç§æ•°æ®æ ¼å¼åŒ–æ–¹æ³•
 */
export class ReportFormatter {
  private textManager: BilingualTextManager;

  constructor(textManager: BilingualTextManager) {
    this.textManager = textManager;
  }

  /**
   * æ ¼å¼åŒ–æ•°å€¼
   * @param num æ•°å€¼
   * @param precision ç²¾åº¦
   * @returns æ ¼å¼åŒ–åçš„æ•°å€¼å­—ç¬¦ä¸²
   */
  formatNumber(num: number, precision: number = 2): string {
    if (num >= 1000000) {
      return `${(num / 1000000).toFixed(1)}M`;
    } else if (num >= 1000) {
      return `${(num / 1000).toFixed(1)}K`;
    }
    return num.toFixed(precision);
  }

  /**
   * æ ¼å¼åŒ–ç™¾åˆ†æ¯”
   * @param num ç™¾åˆ†æ¯”æ•°å€¼ (0-1)
   * @returns æ ¼å¼åŒ–åçš„ç™¾åˆ†æ¯”å­—ç¬¦ä¸²
   */
  formatPercent(num: number): string {
    return `${(num * 100).toFixed(1)}%`;
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´ï¼ˆå°æ—¶ï¼‰
   * @param hours å°æ—¶æ•°
   * @param language è¯­è¨€
   * @returns æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
   */
  formatTime(hours: number, language: Language): string {
    const hoursText = this.textManager.getText('time.hours', language);
    const minutesText = this.textManager.getText('time.minutes', language);
    
    if (hours >= 1) {
      return `${hours.toFixed(1)} ${hoursText}`;
    } else {
      const minutes = Math.round(hours * 60);
      return `${minutes} ${minutesText}`;
    }
  }

  /**
   * æ ¼å¼åŒ–æˆæœ¬
   * @param cost æˆæœ¬æ•°å€¼
   * @returns æ ¼å¼åŒ–åçš„æˆæœ¬å­—ç¬¦ä¸²
   */
  formatCost(cost: number): string {
    return `$${cost.toFixed(4)}`;
  }

  /**
   * æ ¼å¼åŒ–æ•ˆç‡è¯„çº§
   * @param rating è¯„çº§
   * @param language è¯­è¨€
   * @returns æœ¬åœ°åŒ–åçš„è¯„çº§æ–‡æœ¬
   */
  formatRating(rating: string, language: Language): string {
    const ratingKey = `rating.${rating.toLowerCase()}`;
    return this.textManager.getText(ratingKey, language);
  }

  /**
   * æ ¼å¼åŒ–è¶‹åŠ¿
   * @param trend è¶‹åŠ¿æ–¹å‘
   * @param language è¯­è¨€
   * @returns æœ¬åœ°åŒ–åçš„è¶‹åŠ¿æ–‡æœ¬
   */
  formatTrend(trend: 'up' | 'down' | 'stable', language: Language): string {
    const trendKey = `trend.${trend === 'up' ? 'increasing' : trend === 'down' ? 'decreasing' : 'stable'}`;
    return this.textManager.getText(trendKey, language);
  }
}

/**
 * æŠ¥å‘Šæ¨¡æ¿ç”Ÿæˆå™¨
 * ç”Ÿæˆå„ç§æ ¼å¼çš„æŠ¥å‘Šæ¨¡æ¿
 */
export class ReportTemplateGenerator {
  private textManager: BilingualTextManager;
  private formatter: ReportFormatter;

  constructor() {
    this.textManager = new BilingualTextManager();
    this.formatter = new ReportFormatter(this.textManager);
  }

  /**
   * ç”ŸæˆåŸºç¡€ç»Ÿè®¡è¡¨æ ¼æ¨¡æ¿
   * @param format è¾“å‡ºæ ¼å¼
   * @param language è¯­è¨€
   * @returns è¡¨æ ¼é…ç½®
   */
  generateBasicStatsTable(format: ReportFormat, language: Language): TableConfig {
    const title = this.textManager.getText('table.basic_stats', language);
    const metricColumn = this.textManager.getText('column.metric', language);
    const valueColumn = this.textManager.getText('column.value', language);

    return {
      title,
      border: format !== 'brief',
      style: format === 'table' ? 'unicode' : format === 'brief' ? 'compact' : 'ascii',
      columns: [
        {
          key: 'metric',
          title: metricColumn,
          width: 20,
          align: 'left'
        },
        {
          key: 'value',
          title: valueColumn,
          width: 15,
          align: 'right',
          formatter: (value: any) => String(value)
        }
      ]
    };
  }

  /**
   * ç”Ÿæˆæ•ˆç‡æŒ‡æ ‡è¡¨æ ¼æ¨¡æ¿
   * @param format è¾“å‡ºæ ¼å¼
   * @param language è¯­è¨€
   * @returns è¡¨æ ¼é…ç½®
   */
  generateEfficiencyTable(format: ReportFormat, language: Language): TableConfig {
    const title = this.textManager.getText('table.efficiency', language);
    const metricColumn = this.textManager.getText('column.metric', language);
    const valueColumn = this.textManager.getText('column.value', language);

    return {
      title,
      border: format !== 'brief',
      style: format === 'table' ? 'unicode' : format === 'brief' ? 'compact' : 'ascii',
      columns: [
        {
          key: 'metric',
          title: metricColumn,
          width: 25,
          align: 'left'
        },
        {
          key: 'value',
          title: valueColumn,
          width: 15,
          align: 'right'
        }
      ]
    };
  }

  /**
   * ç”Ÿæˆå·¥å…·ä½¿ç”¨è¡¨æ ¼æ¨¡æ¿
   * @param format è¾“å‡ºæ ¼å¼
   * @param language è¯­è¨€
   * @returns è¡¨æ ¼é…ç½®
   */
  generateToolUsageTable(format: ReportFormat, language: Language): TableConfig {
    const title = this.textManager.getText('table.tool_usage', language);
    const toolColumn = this.textManager.getText('column.tool', language);
    const usageColumn = this.textManager.getText('column.usage', language);
    const efficiencyColumn = this.textManager.getText('column.efficiency', language);

    return {
      title,
      border: format !== 'brief',
      style: format === 'table' ? 'unicode' : format === 'brief' ? 'compact' : 'ascii',
      columns: [
        {
          key: 'tool',
          title: toolColumn,
          width: 15,
          align: 'left'
        },
        {
          key: 'usage',
          title: usageColumn,
          width: 10,
          align: 'right'
        },
        {
          key: 'efficiency',
          title: efficiencyColumn,
          width: 12,
          align: 'right'
        }
      ]
    };
  }

  /**
   * ç”ŸæˆæŒ‡æ ‡å¡ç‰‡
   * @param title æ ‡é¢˜
   * @param value æ•°å€¼
   * @param unit å•ä½
   * @param trend è¶‹åŠ¿
   * @param icon å›¾æ ‡
   * @returns æŒ‡æ ‡å¡ç‰‡
   */
  generateMetricCard(
    title: string,
    value: string | number,
    unit?: string,
    trend?: 'up' | 'down' | 'stable',
    icon?: string
  ): MetricCard {
    return {
      title,
      value,
      unit,
      trend,
      icon
    };
  }

  /**
   * ç”Ÿæˆæ´å¯Ÿå¡ç‰‡
   * @param type æ´å¯Ÿç±»å‹
   * @param title æ ‡é¢˜
   * @param content å†…å®¹
   * @param priority ä¼˜å…ˆçº§
   * @param action è¡ŒåŠ¨å»ºè®®
   * @returns æ´å¯Ÿå¡ç‰‡
   */
  generateInsightCard(
    type: 'positive' | 'negative' | 'neutral' | 'warning',
    title: string,
    content: string,
    priority: 'high' | 'medium' | 'low' = 'medium',
    action?: string
  ): InsightCard {
    return {
      type,
      title,
      content,
      priority,
      action
    };
  }

  /**
   * åˆ›å»ºæ¸²æŸ“ä¸Šä¸‹æ–‡
   * @param data åŸå§‹æ•°æ®
   * @param config æŠ¥å‘Šé…ç½®
   * @returns æ¸²æŸ“ä¸Šä¸‹æ–‡
   */
  createRenderContext(data: any, config: ReportConfig): RenderContext {
    const helpers = {
      formatNumber: (num: number, precision?: number) => this.formatter.formatNumber(num, precision),
      formatPercent: (num: number) => this.formatter.formatPercent(num),
      formatTime: (hours: number) => this.formatter.formatTime(hours, config.language),
      formatCost: (cost: number) => this.formatter.formatCost(cost),
      t: (key: string) => this.textManager.getText(key, config.language)
    };

    return {
      data,
      config,
      language: config.language,
      timestamp: new Date().toISOString(),
      helpers
    };
  }

  /**
   * è·å–æ–‡æœ¬ç®¡ç†å™¨
   */
  getTextManager(): BilingualTextManager {
    return this.textManager;
  }

  /**
   * è·å–æ ¼å¼åŒ–å·¥å…·
   */
  getFormatter(): ReportFormatter {
    return this.formatter;
  }
}

/**
 * é¢„å®šä¹‰çš„æŠ¥å‘Šæ¨¡æ¿
 * æä¾›å¸¸ç”¨çš„æŠ¥å‘Šæ¨¡æ¿é…ç½®
 */
export class ReportTemplates {
  private templateGenerator: ReportTemplateGenerator;

  constructor() {
    this.templateGenerator = new ReportTemplateGenerator();
  }

  /**
   * æ—¥æŠ¥æ¨¡æ¿
   */
  readonly dailyTemplate: ReportTemplate = {
    name: 'daily',
    type: 'daily',
    supported_formats: ['table', 'detailed', 'brief'],
    description: 'ç”Ÿæˆæ—¥å¸¸ä½¿ç”¨ç»Ÿè®¡æŠ¥å‘Š',
    render: (data: AnalysisResult, config: ReportConfig): string => {
      return this.renderDailyReport(data, config);
    }
  };

  /**
   * æ•ˆç‡åˆ†ææ¨¡æ¿
   */
  readonly efficiencyTemplate: ReportTemplate = {
    name: 'efficiency',
    type: 'efficiency',
    supported_formats: ['table', 'detailed', 'brief', 'chart'],
    description: 'ç”Ÿæˆæ•ˆç‡åˆ†ææŠ¥å‘Š',
    render: (data: AnalysisResult, config: ReportConfig): string => {
      return this.renderEfficiencyReport(data, config);
    }
  };

  /**
   * è¶‹åŠ¿åˆ†ææ¨¡æ¿
   */
  readonly trendsTemplate: ReportTemplate = {
    name: 'trends',
    type: 'trends',
    supported_formats: ['detailed', 'chart'],
    description: 'ç”Ÿæˆè¶‹åŠ¿åˆ†ææŠ¥å‘Š',
    render: (data: AnalysisResult, config: ReportConfig): string => {
      return this.renderTrendsReport(data, config);
    }
  };

  /**
   * æ´å¯Ÿåˆ†ææ¨¡æ¿
   */
  readonly insightsTemplate: ReportTemplate = {
    name: 'insights',
    type: 'insights',
    supported_formats: ['detailed', 'insights'],
    description: 'ç”Ÿæˆæ™ºèƒ½æ´å¯ŸæŠ¥å‘Š',
    render: (data: AnalysisResult, config: ReportConfig): string => {
      return this.renderInsightsReport(data, config);
    }
  };

  /**
   * æˆæœ¬åˆ†ææ¨¡æ¿
   */
  readonly costTemplate: ReportTemplate = {
    name: 'cost',
    type: 'cost',
    supported_formats: ['table', 'detailed', 'financial'],
    description: 'ç”Ÿæˆæˆæœ¬åˆ†ææŠ¥å‘Š',
    render: (data: AnalysisResult, config: ReportConfig): string => {
      return this.renderCostReport(data, config);
    }
  };

  /**
   * è·å–æ‰€æœ‰æ¨¡æ¿
   */
  getAllTemplates(): ReportTemplate[] {
    return [
      this.dailyTemplate,
      this.efficiencyTemplate,
      this.trendsTemplate,
      this.insightsTemplate,
      this.costTemplate
    ];
  }

  /**
   * æ ¹æ®ç±»å‹è·å–æ¨¡æ¿
   * @param type æŠ¥å‘Šç±»å‹
   * @returns å¯¹åº”çš„æ¨¡æ¿ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›undefined
   */
  getTemplate(type: ReportType): ReportTemplate | undefined {
    return this.getAllTemplates().find(template => template.type === type);
  }

  // ===== ç§æœ‰æ–¹æ³•ï¼šå…·ä½“çš„æŠ¥å‘Šæ¸²æŸ“å®ç° =====

  /**
   * æ¸²æŸ“æ—¥æŠ¥
   * @private
   */
  private renderDailyReport(data: AnalysisResult, config: ReportConfig): string {
    const context = this.templateGenerator.createRenderContext(data, config);
    const { helpers, language } = context;

    let report = '';

    // æŠ¥å‘Šæ ‡é¢˜
    const title = helpers.t('report.title.daily');
    report += `${title}\n`;
    report += '='.repeat(title.length) + '\n\n';

    // åŸºæœ¬ä¿¡æ¯
    report += `ğŸ“… æ—¶é—´èŒƒå›´: ${data.timeframe}\n`;
    report += `ğŸ“‚ é¡¹ç›®: ${data.project_path}\n`;
    report += `ğŸ“Š æ•°æ®æº: ${data.data_source}\n\n`;

    // åŸºç¡€ç»Ÿè®¡è¡¨æ ¼
    if (config.format !== 'brief') {
      report += this.generateBasicStatsSection(data.basic_stats, config, helpers);
    }

    // æ•ˆç‡æŒ‡æ ‡
    if (data.efficiency) {
      report += this.generateEfficiencySection(data.efficiency, config, helpers);
    }

    // æ´å¯Ÿï¼ˆå¦‚æœæœ‰ï¼‰
    if (config.include_insights && data.insights) {
      report += this.generateInsightsSection(data.insights, config, helpers);
    }

    return report;
  }

  /**
   * æ¸²æŸ“æ•ˆç‡æŠ¥å‘Š
   * @private
   */
  private renderEfficiencyReport(data: AnalysisResult, config: ReportConfig): string {
    const context = this.templateGenerator.createRenderContext(data, config);
    const { helpers } = context;

    let report = '';

    // æŠ¥å‘Šæ ‡é¢˜
    const title = helpers.t('report.title.efficiency');
    report += `${title}\n`;
    report += '='.repeat(title.length) + '\n\n';

    // æ•ˆç‡è¯¦ç»†åˆ†æ
    if (data.efficiency) {
      report += this.generateDetailedEfficiencySection(data.efficiency, config, helpers);
    }

    return report;
  }

  /**
   * æ¸²æŸ“è¶‹åŠ¿æŠ¥å‘Š
   * @private
   */
  private renderTrendsReport(data: AnalysisResult, config: ReportConfig): string {
    const context = this.templateGenerator.createRenderContext(data, config);
    const { helpers } = context;

    let report = '';

    // æŠ¥å‘Šæ ‡é¢˜
    const title = helpers.t('report.title.trends');
    report += `${title}\n`;
    report += '='.repeat(title.length) + '\n\n';

    // è¶‹åŠ¿åˆ†æ
    if (data.trends) {
      report += this.generateTrendsSection(data.trends, config, helpers);
    }

    return report;
  }

  /**
   * æ¸²æŸ“æ´å¯ŸæŠ¥å‘Š
   * @private
   */
  private renderInsightsReport(data: AnalysisResult, config: ReportConfig): string {
    const context = this.templateGenerator.createRenderContext(data, config);
    const { helpers } = context;

    let report = '';

    // æŠ¥å‘Šæ ‡é¢˜
    const title = helpers.t('report.title.insights');
    report += `${title}\n`;
    report += '='.repeat(title.length) + '\n\n';

    // æ™ºèƒ½æ´å¯Ÿè¯¦æƒ…
    if (data.insights) {
      report += this.generateDetailedInsightsSection(data.insights, config, helpers);
    }

    return report;
  }

  /**
   * æ¸²æŸ“æˆæœ¬æŠ¥å‘Š
   * @private
   */
  private renderCostReport(data: AnalysisResult, config: ReportConfig): string {
    const context = this.templateGenerator.createRenderContext(data, config);
    const { helpers } = context;

    let report = '';

    // æŠ¥å‘Šæ ‡é¢˜
    const title = helpers.t('report.title.cost');
    report += `${title}\n`;
    report += '='.repeat(title.length) + '\n\n';

    // æˆæœ¬è¯¦ç»†åˆ†æ
    report += this.generateCostSection(data.basic_stats, data.efficiency, config, helpers);

    return report;
  }

  // ===== æŠ¥å‘ŠèŠ‚ç”Ÿæˆæ–¹æ³• =====

  /**
   * ç”ŸæˆåŸºç¡€ç»Ÿè®¡èŠ‚
   * @private
   */
  private generateBasicStatsSection(
    stats: BasicStats, 
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = '';

    const sectionTitle = helpers.t('section.summary');
    section += `${sectionTitle}\n`;
    section += '-'.repeat(sectionTitle.length) + '\n';

    section += `â° ${helpers.t('metric.total_time')}: ${helpers.formatTime(stats.total_time_hours)}\n`;
    section += `ğŸ”¤ ${helpers.t('metric.total_tokens')}: ${helpers.formatNumber(stats.total_tokens, 0)}\n`;
    section += `ğŸ’° ${helpers.t('metric.total_cost')}: ${helpers.formatCost(stats.total_cost_usd)}\n`;
    section += `ğŸ“ ${helpers.t('metric.files_modified')}: ${stats.files_modified}\n\n`;

    return section;
  }

  /**
   * ç”Ÿæˆæ•ˆç‡èŠ‚
   * @private
   */
  private generateEfficiencySection(
    efficiency: EfficiencyMetrics, 
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = '';

    const sectionTitle = helpers.t('table.efficiency');
    section += `${sectionTitle}\n`;
    section += '-'.repeat(sectionTitle.length) + '\n';

    section += `ğŸ“Š ${helpers.t('metric.productivity_score')}: ${efficiency.productivity_score.toFixed(1)}/10\n`;
    section += `âš¡ æ•ˆç‡è¯„çº§: ${helpers.t(`rating.${efficiency.efficiency_rating.toLowerCase()}`)}\n`;
    section += `ğŸš€ ${helpers.t('metric.tokens_per_hour')}: ${helpers.formatNumber(efficiency.tokens_per_hour, 0)}\n`;
    section += `ğŸ“ ${helpers.t('metric.lines_per_hour')}: ${helpers.formatNumber(efficiency.lines_per_hour, 0)}\n\n`;

    return section;
  }

  /**
   * ç”Ÿæˆè¯¦ç»†æ•ˆç‡èŠ‚
   * @private
   */
  private generateDetailedEfficiencySection(
    efficiency: EfficiencyMetrics, 
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = this.generateEfficiencySection(efficiency, config, helpers);

    // æ·»åŠ å·¥å…·ä½¿ç”¨åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰
    section += '\n';

    return section;
  }

  /**
   * ç”Ÿæˆæ´å¯ŸèŠ‚
   * @private
   */
  private generateInsightsSection(
    insights: SmartInsights, 
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = '';

    const sectionTitle = helpers.t('section.insights');
    section += `${sectionTitle}\n`;
    section += '-'.repeat(sectionTitle.length) + '\n';

    // æ˜¾ç¤ºå‰3ä¸ªæ´å¯Ÿ
    insights.insights.slice(0, 3).forEach((insight, index) => {
      const icon = index === 0 ? 'âœ…' : index === 1 ? 'âš ï¸' : 'â„¹ï¸';
      section += `${icon} ${insight}\n\n`;
    });

    return section;
  }

  /**
   * ç”Ÿæˆè¯¦ç»†æ´å¯ŸèŠ‚
   * @private
   */
  private generateDetailedInsightsSection(
    insights: SmartInsights, 
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = '';

    // æ˜¾ç¤ºæ‰€æœ‰æ´å¯Ÿ
    insights.insights.forEach((insight, index) => {
      const icon = index % 3 === 0 ? 'âœ…' : index % 3 === 1 ? 'âš ï¸' : 'â„¹ï¸';
      section += `${icon} ${insight}\n\n`;
    });

    // æ˜¾ç¤ºå»ºè®®
    if (insights.recommendations && insights.recommendations.length > 0) {
      const recSection = helpers.t('section.recommendations');
      section += `${recSection}\n`;
      section += '-'.repeat(recSection.length) + '\n';

      insights.recommendations.forEach((rec, index) => {
        section += `${index + 1}. ${rec}\n`;
      });
      section += '\n';
    }

    return section;
  }

  /**
   * ç”Ÿæˆè¶‹åŠ¿èŠ‚
   * @private
   */
  private generateTrendsSection(
    trends: TrendAnalysis, 
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = '';

    const timeDirection = trends.time_trend > 0 ? 'ä¸Šå‡' : trends.time_trend < 0 ? 'ä¸‹é™' : 'ç¨³å®š';
    const tokenDirection = trends.token_trend > 0 ? 'ä¸Šå‡' : trends.token_trend < 0 ? 'ä¸‹é™' : 'ç¨³å®š';
    const productivityDirection = trends.productivity_trend > 0 ? 'ä¸Šå‡' : trends.productivity_trend < 0 ? 'ä¸‹é™' : 'ç¨³å®š';
    
    section += `ğŸ“ˆ æ—¶é—´ä½¿ç”¨è¶‹åŠ¿: ${timeDirection} (${(trends.time_trend * 100).toFixed(1)}%)\n`;
    section += `ğŸ”¤ Tokenæ¶ˆè€—è¶‹åŠ¿: ${tokenDirection} (${(trends.token_trend * 100).toFixed(1)}%)\n`;
    section += `âš¡ ç”Ÿäº§åŠ›è¶‹åŠ¿: ${productivityDirection} (${(trends.productivity_trend * 100).toFixed(1)}%)\n\n`;

    return section;
  }

  /**
   * ç”Ÿæˆæˆæœ¬èŠ‚
   * @private
   */
  private generateCostSection(
    stats: BasicStats,
    efficiency: EfficiencyMetrics | undefined,
    config: ReportConfig, 
    helpers: RenderContext['helpers']
  ): string {
    let section = '';

    section += `ğŸ’° æ€»æˆæœ¬: ${helpers.formatCost(stats.total_cost_usd)}\n`;
    section += `â° å°æ—¶æˆæœ¬: ${helpers.formatCost(stats.total_cost_usd / stats.total_time_hours)}\n`;
    
    if (efficiency) {
      const costPerLine = stats.total_cost_usd / efficiency.estimated_lines_changed;
      section += `ğŸ“ æ¯è¡Œä»£ç æˆæœ¬: ${helpers.formatCost(costPerLine)}\n`;
    }
    
    section += '\n';

    return section;
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const reportTemplates = new ReportTemplates();
export const reportTemplateGenerator = new ReportTemplateGenerator();
export const bilingualTextManager = reportTemplateGenerator.getTextManager();